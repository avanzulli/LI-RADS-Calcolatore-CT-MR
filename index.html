<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calcolatore LI-RADS® CT/MR v2018</title>
<meta name="description" content="Calcolatore LI-RADS CT/MR v2018 per pazienti a rischio di HCC.">
<!-- PWA / iOS -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0c4a6e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
<link rel="icon" type="image/png" href="icons/icon-192.png">
<style>
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.5;margin:0;background:#fafafa;color:#111}
  header{background:#0c4a6e;color:#fff;padding:16px 20px}
  main{max-width:980px;margin:0 auto;padding:20px}
  h1{font-size:22px;margin:0}
  h2{font-size:18px;margin-top:24px}
  fieldset{border:1px solid #e5e7eb;border-radius:10px;margin:18px 0;padding:12px;background:#fff;min-width:0}
  legend{padding:0 8px;color:#0c4a6e;font-weight:600}
  label{display:block;margin:6px 0}
  .row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start}
  .col{flex:1 1 280px;min-width:240px}
  select, input[type="number"], input[type="text"] {width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
  select:focus, input:focus{outline:2px solid #0ea5e9;outline-offset:1px}
  .hint{font-size:12px;color:#475569}
  .pill{display:inline-flex;align-items:center;background:#eef;padding:4px 10px;border-radius:999px;margin:0 8px 8px 0;font-size:12px;white-space:normal}
  .pillwrap{display:flex;flex-wrap:wrap;margin-top:8px}
  .out{border-left:4px solid #0c4a6e;background:#fff;padding:12px 12px;margin-top:12px;border-radius:8px;min-width:0;word-wrap:break-word}
  .cat{font-weight:800;font-size:20px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;margin-left:8px}
  .lr-1{background:#e5f6ff}
  .lr-2{background:#e8fff2}
  .lr-3{background:#fff8e1}
  .lr-4{background:#ffe9d6}
  .lr-5{background:#ffe1e1}
  .lr-m{background:#e9e1ff}
  .lr-tiv{background:#ffd6f0}
  .small{font-size:12px;color:#334155}
  .footer{font-size:12px;color:#334155;margin-top:16px}
  .btn{background:#0c4a6e;color:#fff;border:none;padding:12px 16px;border-radius:10px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;align-items:start}
  .checks label{display:flex;align-items:flex-start;gap:10px;line-height:1.3}
  .checks input[type="checkbox"]{margin-top:2px;flex:0 0 auto}
  .checks{min-width:0}
  @media (max-width: 480px){
    h1{font-size:20px}
    .col{min-width:100%}
    .btn{width:100%}
  }
</style>
</head>
<body>
<header>
  <h1>Calcolatore LI-RADS® CT/MR v2018</h1>
  <div class="hint">Per pazienti a rischio di HCC (cirrosi, HBV cronica, HCC pregresso). Basato su ACR LI-RADS CT/MRI v2018.</div>
</header>
<main>
  <fieldset>
    <legend>Prerequisiti</legend>
    <div class="grid2 checks">
      <label><input id="atRisk" type="checkbox" checked> <span>Paziente a rischio (cirrosi o HBV cronico o HCC pregresso)</span></label>
      <label><input id="pathProven" type="checkbox"> <span>Lesione già provata istologicamente (se sì, non assegnare LI-RADS)</span></label>
      <label><input id="nonCateg" type="checkbox"> <span>Esame non categorizzabile (omissioni/degradazione: → LR-NC)</span></label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Scorciatoie (override)</legend>
    <div class="grid2 checks">
      <label><input id="tiv" type="checkbox"> <span>Presenza certa di trombo neoplastico / tessuto molle potenziato in vena → LR‑TIV</span></label>
      <label><input id="lrm" type="checkbox"> <span>Aspetto <em>targetoid</em> / infiltrativo o altre caratteristiche non‑HCC → LR‑M</span></label>
      <label><input id="lr1" type="checkbox"> <span>Diagnosi certa di benignità (cisti, angioma, ecc.) → LR‑1</span></label>
      <label><input id="lr2" type="checkbox"> <span>Verosimile benignità → LR‑2</span></label>
    </div>
    <div class="hint small">Usare LR‑M e LR‑TIV quando i criteri sono soddisfatti indipendentemente dalle maggiori.</div>
  </fieldset>

  <fieldset>
    <legend>Dati dell'osservazione (Tabella diagnostica)</legend>
    <div class="row">
      <div class="col">
        <label>Modalità/mezzo di contrasto
          <select id="modality" aria-label="Modalità">
            <option value="CT">CT (ECA)</option>
            <option value="MRI_ECA">MRI (ECA)</option>
            <option value="MRI_HBA">MRI (HBA, es. gadoxetato)</option>
          </select>
        </label>
      </div>
      <div class="col">
        <label>Diametro massimo (mm)
          <input id="size" type="number" min="1" step="1" value="18" inputmode="numeric">
        </label>
      </div>
      <div class="col">
        <label>APHE non-rim in fase arteriosa
          <select id="aphe" aria-label="APHE">
            <option value="none">Assente</option>
            <option value="nonrim">Presente (non-rim)</option>
          </select>
        </label>
      </div>
    </div>

    <div class="row checks">
      <div class="col">
        <label><input id="washout" type="checkbox"> <span>Washout non-periferico</span></label>
        <div class="hint small">Applicabile in PV tardiva/equilibrio (CT/MRI ECA) o portale tardiva su MRI HBA; non usare la HBP per definire washout.</div>
      </div>
      <div class="col">
        <label><input id="capsule" type="checkbox"> <span>Capsula potenziante</span></label>
      </div>
      <div class="col">
        <label><input id="tgrowth" type="checkbox"> <span>Threshold growth (≥50% in ≤6 mesi)</span></label>
        <div class="hint small">La crescita sub‑threshold non soddisfa il criterio maggiore.</div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Caratteristiche ancillari (opzionali)</legend>
    <div class="row checks">
      <div class="col">
        <label><input id="afMal" type="checkbox"> <span>≥1 ancillare che favorisce malignità (es. restrizione diffusiva, T2 lieve‑moderata, ipointensità HBP, corona enhancement...)</span></label>
      </div>
      <div class="col">
        <label><input id="afBen" type="checkbox"> <span>≥1 ancillare che favorisce benignità (es. parallela al sangue, stabilità >2 anni, vasi indisturbati...)</span></label>
      </div>
    </div>
    <div class="hint small">Le ancillari non possono portare a LR‑5 e non si applicano se coesistono sia pro‑malignità sia pro‑benignità.</div>
  </fieldset>

  <button id="calc" class="btn">Calcola LI‑RADS</button>

  <div id="output" class="out" style="display:none"></div>

  <div class="footer">
    <p>Fonti principali: ACR <strong>LI‑RADS® CT/MRI v2018 Core</strong>. Usare solo in pazienti a rischio di HCC. Questo strumento non sostituisce il giudizio clinico‑radiologico.</p>
  </div>
</main>

<script>
function explainRule(txt){const p=document.createElement('div');p.className='small';p.textContent='• '+txt;return p;}

function computeBaseCategory(aphe,size,washout,capsule,tgrowth){
  const addMaj = (washout?1:0)+(capsule?1:0)+(tgrowth?1:0);
  if(aphe==='none'){
    if(size<20){
      if(addMaj===0) return {cat:'LR-3', why:['<20 mm senza APHE e senza altre maggiori → LR‑3']};
      if(addMaj===1) return {cat:'LR-3', why:['<20 mm senza APHE con 1 maggiore → LR‑3']};
      return {cat:'LR-4', why:['<20 mm senza APHE con ≥2 maggiori → LR‑4']};
    } else {
      if(addMaj===0) return {cat:'LR-3', why:['≥20 mm senza APHE e senza altre maggiori → LR‑3']};
      return {cat:'LR-4', why:['≥20 mm senza APHE con ≥1 maggiore → LR‑4']};
    }
  }
  if(size<10){
    if(addMaj===0) return {cat:'LR-3', why:['<10 mm con APHE non‑rim e 0 maggiori addizionali → LR‑3']};
    if(addMaj===1) return {cat:'LR-4', why:['<10 mm con APHE non‑rim e 1 maggiore addizionale → LR‑4']};
    return {cat:'LR-4', why:['<10 mm con APHE non‑rim e ≥2 maggiori addizionali → LR‑4']};
  }
  if(size>=10 && size<=19){
    if(addMaj===0) return {cat:'LR-4', why:['10–19 mm con APHE non‑rim e 0 maggiori addizionali → LR‑4']};
    if(addMaj===1){
      if(washout || tgrowth){
        return {cat:'LR-5', why:['10–19 mm con APHE non‑rim + (washout non‑periferico OPPURE threshold growth) → LR‑5']};
      } else {
        return {cat:'LR-4', why:['10–19 mm con APHE non‑rim + solo capsula → LR‑4']};
      }
    }
    return {cat:'LR-5', why:['10–19 mm con APHE non‑rim e ≥2 maggiori (qualunque combinazione) → LR‑5']};
  }
  if(addMaj===0) return {cat:'LR-4', why:['≥20 mm con APHE non‑rim e 0 maggiori addizionali → LR‑4']};
  return {cat:'LR-5', why:['≥20 mm con APHE non‑rim e ≥1 maggiore addizionale → LR‑5']};
}

function adjustWithAF(cat,afMal,afBen){
  const order = ['LR-1','LR-2','LR-3','LR-4','LR-5'];
  let idx = order.indexOf(cat);
  let note = null;
  if(afMal && afBen){ note = 'Presenti ancillari contrastanti: nessun aggiustamento.'; return {cat, note}; }
  if(afMal && cat!=='LR-5'){
    if(idx>=0 && idx<4){ idx = Math.min(idx+1, 3); }
    note = 'Upgrade di 1 categoria per ancillari pro‑malignità (mai fino a LR‑5).';
    return {cat: order[idx], note};
  }
  if(afBen){
    if(idx>0){ idx = idx-1; }
    note = 'Downgrade di 1 categoria per ancillari pro‑benignità.';
    return {cat: order[idx], note};
  }
  return {cat, note};
}

function runCalc(){
  const out = document.getElementById('output');
  out.innerHTML='';
  out.style.display='block';

  const atRisk = document.getElementById('atRisk').checked;
  const pathProven = document.getElementById('pathProven').checked;
  const nonCateg = document.getElementById('nonCateg').checked;
  const tiv = document.getElementById('tiv').checked;
  const lrm = document.getElementById('lrm').checked;
  const lr1 = document.getElementById('lr1').checked;
  const lr2 = document.getElementById('lr2').checked;

  if(pathProven){
    out.className='out';
    out.innerHTML = '<div class="cat">Lesione provata istologicamente: non assegnare LI‑RADS.</div>';
    return;
  }
  if(nonCateg){
    out.className='out lr-3';
    out.innerHTML = '<div class="cat">LR‑NC</div><div class="small">Esame non categorizzabile per omissioni o artefatti.</div>';
    return;
  }
  if(tiv){ out.className='out lr-tiv'; out.innerHTML = '<div class="cat">LR‑TIV</div><div class="small">Tumore in vena: tessuto molle intravascolare con potenziamento.</div>'; return; }
  if(lrm){ out.className='out lr-m'; out.innerHTML = '<div class="cat">LR‑M</div><div class="small">Aspetto non specifico per HCC (p.es. targetoid, infiltrativo).</div>'; return; }
  if(lr1){ out.className='out lr-1'; out.innerHTML = '<div class="cat">LR‑1</div><div class="small">Aspetto sicuramente benigno.</div>'; return; }
  if(lr2){ out.className='out lr-2'; out.innerHTML = '<div class="cat">LR‑2</div><div class="small">Aspetto probabilmente benigno.</div>'; return; }

  const size = parseFloat(document.getElementById('size').value||'0');
  const aphe = document.getElementById('aphe').value;
  const washout = document.getElementById('washout').checked;
  const capsule = document.getElementById('capsule').checked;
  const tgrowth = document.getElementById('tgrowth').checked;
  const afMal = document.getElementById('afMal').checked;
  const afBen = document.getElementById('afBen').checked;

  if(!atRisk){
    out.className='out';
    out.innerHTML = '<div class="cat">Attenzione</div><div class="small">LI‑RADS si applica solo a pazienti a rischio HCC. Senza fattori di rischio, non assegnare una categoria: usa report descrittivo.</div>';
    return;
  }

  const base = computeBaseCategory(aphe,size,washout,capsule,tgrowth);
  let cat = base.cat;
  let why = base.why.slice();

  const adj = adjustWithAF(cat,afMal,afBen);
  cat = adj.cat;
  if(adj.note) why.push(adj.note);

  let colorClass = 'lr-3';
  if(cat==='LR-1') colorClass='lr-1';
  else if(cat==='LR-2') colorClass='lr-2';
  else if(cat==='LR-3') colorClass='lr-3';
  else if(cat==='LR-4') colorClass='lr-4';
  else if(cat==='LR-5') colorClass='lr-5';

  out.className='out '+colorClass;
  const title=document.createElement('div');
  title.className='cat';
  title.textContent=cat;
  out.appendChild(title);

  const pills=document.createElement('div');
  pills.className='pillwrap';
  pills.innerHTML = '<span class="pill">Diametro: '+(isFinite(size)?(size+' mm'):'n/d')+'</span>' +
                    '<span class="pill">APHE: '+(aphe==='nonrim'?'presente (non‑rim)':'assente')+'</span>' +
                    (washout?'<span class="pill">Washout</span>':'') +
                    (capsule?'<span class="pill">Capsula</span>':'') +
                    (tgrowth?'<span class="pill">Threshold growth</span>':'') ;
  out.appendChild(pills);

  const expl=document.createElement('div');
  expl.className='small';
  expl.style.marginTop='6px';
  expl.textContent='Motivazione:';
  out.appendChild(expl);
  why.forEach(w=> out.appendChild(explainRule(w)));

  const optn=document.createElement('div');
  optn.className='small';
  optn.style.marginTop='8px';
  optn.innerHTML='Nota OPTN: 10–19 mm + APHE + washout è LR‑5 ma non soddisfa OPTN‑5.';
  out.appendChild(optn);
}

document.getElementById('calc').addEventListener('click', runCalc);

// (Facoltativo) registra un service worker se presente
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
</script>
</body>
</html>
